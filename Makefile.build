# Makefile –¥–ª—è —Å–±–æ—Ä–∫–∏ RPM –∏ DEB –ø–∞–∫–µ—Ç–æ–≤ sshgo

NAME=sshgo
VERSION=2.0.0
RELEASE=1

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
BUILDDIR=$(HOME)/rpmbuild
SOURCEDIR=$(BUILDDIR)/SOURCES
SPECDIR=$(BUILDDIR)/SPECS
BUILDDIR=$(BUILDDIR)/BUILD

.PHONY: all clean prepare build rpm deb install-rpm install-deb

all: rpm deb

# –ü—É—Å—Ç–∞—è —Ü–µ–ª—å build –¥–ª—è debhelper (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏)
build:
	@echo "üì¶ –°–±–æ—Ä–∫–∞ —á–µ—Ä–µ–∑ debhelper..."
	@true

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π RPM
prepare:
	@echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å–±–æ—Ä–∫–∏ RPM..."
	mkdir -p $(HOME)/rpmbuild/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
	@echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
source: prepare
	@echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞..."
	@PROJECT_DIR=$$(basename $$(pwd)); \
	PROJECT_PARENT=$$(dirname $$(pwd)); \
	cd $$PROJECT_PARENT && tar -czf $(HOME)/rpmbuild/SOURCES/$(NAME)-$(VERSION).tar.gz \
		--exclude='.git' \
		--exclude='__pycache__' \
		--exclude='*.pyc' \
		--exclude='*.pyo' \
		--exclude='.pytest_cache' \
		--exclude='*.egg-info' \
		$$PROJECT_DIR/
	@echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: $(HOME)/rpmbuild/SOURCES/$(NAME)-$(VERSION).tar.gz"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ spec —Ñ–∞–π–ª–∞
spec: prepare
	@echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ spec —Ñ–∞–π–ª–∞..."
	cp rpm/$(NAME).spec $(HOME)/rpmbuild/SPECS/
	@echo "‚úÖ Spec —Ñ–∞–π–ª —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"

# –°–±–æ—Ä–∫–∞ RPM
rpm: source spec
	@echo "üî® –°–±–æ—Ä–∫–∞ RPM –ø–∞–∫–µ—Ç–∞..."
	rpmbuild -ba $(HOME)/rpmbuild/SPECS/$(NAME).spec
	@echo "‚úÖ RPM –ø–∞–∫–µ—Ç —Å–æ–±—Ä–∞–Ω!"
	@echo "üì¶ –§–∞–π–ª—ã:"
	@ls -lh $(HOME)/rpmbuild/RPMS/*/$(NAME)-$(VERSION)-$(RELEASE)*.rpm
	@ls -lh $(HOME)/rpmbuild/SRPMS/$(NAME)-$(VERSION)-$(RELEASE)*.src.rpm

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ RPM (—Ç—Ä–µ–±—É–µ—Ç sudo)
install-rpm: rpm
	@echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ RPM –ø–∞–∫–µ—Ç–∞..."
	sudo rpm -ivh $(HOME)/rpmbuild/RPMS/*/$(NAME)-$(VERSION)-$(RELEASE)*.rpm
	@echo "‚úÖ –ü–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

# –û—á–∏—Å—Ç–∫–∞
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞..."
	rm -rf $(HOME)/rpmbuild/BUILD/$(NAME)-$(VERSION)
	rm -rf $(HOME)/rpmbuild/BUILDROOT/$(NAME)-$(VERSION)-$(RELEASE)*
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–≤–∫–ª—é—á–∞—è –∞—Ä—Ö–∏–≤—ã)
distclean: clean
	rm -f $(HOME)/rpmbuild/SOURCES/$(NAME)-$(VERSION).tar.gz
	rm -f $(HOME)/rpmbuild/SPECS/$(NAME).spec
	@echo "‚úÖ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±—Ä–∞–Ω–Ω–æ–º –ø–∞–∫–µ—Ç–µ
info: rpm
	@echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ:"
	rpm -qip $(HOME)/rpmbuild/RPMS/*/$(NAME)-$(VERSION)-$(RELEASE)*.rpm
	@echo ""
	@echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–∫–µ—Ç–∞:"
	rpm -qlp $(HOME)/rpmbuild/RPMS/*/$(NAME)-$(VERSION)-$(RELEASE)*.rpm

# –°–±–æ—Ä–∫–∞ DEB –ø–∞–∫–µ—Ç–∞
deb:
	@echo "üì¶ –°–±–æ—Ä–∫–∞ DEB –ø–∞–∫–µ—Ç–∞..."
	@if ! command -v dpkg-buildpackage >/dev/null 2>&1; then \
		echo "‚ùå dpkg-buildpackage –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: sudo apt-get install build-essential devscripts"; \
		exit 1; \
	fi
	dpkg-buildpackage -b -uc -us
	@echo "‚úÖ DEB –ø–∞–∫–µ—Ç —Å–æ–±—Ä–∞–Ω!"
	@echo "üì¶ –§–∞–π–ª—ã:"
	@ls -lh ../$(NAME)_$(VERSION)-$(RELEASE)*.deb 2>/dev/null || echo "   –§–∞–π–ª—ã –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ DEB (—Ç—Ä–µ–±—É–µ—Ç sudo)
install-deb: deb
	@echo "üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞ DEB –ø–∞–∫–µ—Ç–∞..."
	sudo dpkg -i ../$(NAME)_$(VERSION)-$(RELEASE)*.deb || sudo apt-get install -f
	@echo "‚úÖ –ü–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ DEB –ø–∞–∫–µ—Ç–µ
info-deb: deb
	@echo "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞–∫–µ—Ç–µ:"
	@dpkg -I ../$(NAME)_$(VERSION)-$(RELEASE)*.deb 2>/dev/null || echo "–ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
	@echo ""
	@echo "üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–∫–µ—Ç–∞:"
	@dpkg -c ../$(NAME)_$(VERSION)-$(RELEASE)*.deb 2>/dev/null || echo "–ü–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –û—á–∏—Å—Ç–∫–∞ DEB
clean-deb:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ DEB —Ñ–∞–π–ª–æ–≤..."
	rm -rf debian/$(NAME)
	rm -rf debian/.debhelper
	rm -f debian/files
	rm -f debian/*.substvars
	rm -f debian/*.debhelper.log
	rm -f ../$(NAME)_$(VERSION)-$(RELEASE)*.deb
	rm -f ../$(NAME)_$(VERSION)-$(RELEASE)*.changes
	rm -f ../$(NAME)_$(VERSION)-$(RELEASE)*.buildinfo
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@echo ""
	@echo "RPM –ø–∞–∫–µ—Ç:"
	@echo "  make prepare      - —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–±–æ—Ä–∫–∏"
	@echo "  make source        - —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π –∞—Ä—Ö–∏–≤"
	@echo "  make spec          - —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å spec —Ñ–∞–π–ª"
	@echo "  make rpm           - —Å–æ–±—Ä–∞—Ç—å RPM –ø–∞–∫–µ—Ç"
	@echo "  make install-rpm   - —Å–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å RPM"
	@echo ""
	@echo "DEB –ø–∞–∫–µ—Ç:"
	@echo "  make deb           - —Å–æ–±—Ä–∞—Ç—å DEB –ø–∞–∫–µ—Ç"
	@echo "  make install-deb   - —Å–æ–±—Ä–∞—Ç—å –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å DEB"
	@echo "  make info-deb       - –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ DEB –ø–∞–∫–µ—Ç–µ"
	@echo "  make clean-deb      - –æ—á–∏—Å—Ç–∏—Ç—å DEB —Ñ–∞–π–ª—ã"
	@echo ""
	@echo "–û–±—â–∏–µ:"
	@echo "  make clean         - –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  make distclean     - –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞"
	@echo "  make info          - –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ RPM –ø–∞–∫–µ—Ç–µ"
	@echo "  make help          - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"

